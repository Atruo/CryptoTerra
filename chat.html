<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="/css/estilo.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script type="text/javascript" src="/scripts/msg.js">

</script>
</head>
<body onload="time();">

<h2 class="title">CRYPTO-TERRA</h2>
<!-- Usuarios del chat -->
<div id="usuarios" class="container">
  <p>Usuarios:</p>
    <li>Pepe</li>
    <li>Lola</li>
    <li>Paco</li>
</div>
<!-- Chat -->
<div class="container" id="contenedor">
  <!-- Mensaje -->
  <div id="chat">
  </div>
  <!-- Escribir/mandar-->
  <div class="messages" id="nMessages"></div>
      <input type="text" name="" id="nTxt" class="form-control" onkeyup="enter();">
      <input type="button" value="Enviar" id="nBtn" class="btn btn-primary"  onclick="enviar();">
  </div>
</div>

<!-- Script-->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha256.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/pbkdf2.js"></script>
<script src="http://svn.code.sf.net/p/pidcrypt/code/trunk/javascripts/rsa.js"></script>

<script>
var nBtn = document.getElementById("nBtn");//Boton
var nTxt = document.getElementById("nTxt");//Texto
var nMessages = document.getElementById("chat");//Historial
var usuarios = document.getElementById('usuarios');//Lista usuarios
var claveAES, pubKEY, privKEY;//Listado de claves
  var socket = io();
  socket.on("connect", function(){
      var nRoom = "nRoom";
      socket.emit('nRoom', nRoom);
  });
  socket.on("primero", function(data){
      //Crear clave AES y emitirla al resto
       var salt = CryptoJS.lib.WordArray.random(128/8);
       var key256Bits = CryptoJS.PBKDF2("Secret Passphrase", salt, { keySize: 256/32 });
       claveAES = key256Bits.toString();
  });
  nBtn.addEventListener("click", function(){//Si pinchamos en el bot√≥n
    //cifrar
    if (nTxt.value !== '') {
      var mensajeCIF = CryptoJS.AES.encrypt(nTxt.value, 'claveAES').toString();
        socket.emit("node new message", mensajeCIF);//Emitimos mensaje nuevo cifrado
    }

  });
  socket.on("node news", function(data){//Si hay un mensaje nuevo...
    //descifrar
    var des  = CryptoJS.AES.decrypt(data[1], 'claveAES');
    var mensajeDES = des.toString(CryptoJS.enc.Utf8);
    //Escribimos el mensaje
    var chat = document.getElementById('chat');

    if (data[0] === window.location.href.split('3000/')[1]) {//PARA EVITAR QUE SE ESCRIBA EL PROPIA MENSAJE CAMBIAR CON URL DE NGROK!!!
      chat.innerHTML += `<div class="container darker">
        <img src="/img/user.png" alt="Avatar" style="width:100%;"><u>${data[0]}</u>
        <p><strong>&gt;</strong> ${mensajeDES}</p>
        <span class="time-left" id = 'hora'></span>
      </div>`
      nTxt.value = '';
    }else{
      chat.innerHTML += `<div class="container">
        <img src="/img/user.png" alt="Avatar" style="width:100%;"><u>${data[0]}</u>
        <p><strong>&gt;</strong> ${mensajeDES}</p>
        <span class="time-left" id = 'hora'></span>
      </div>`
    nTxt.value = '';
    }


});
  socket.on("node new user", function(data){//Si hay un usuario nuevo....
      nMessages.innerHTML = nMessages.innerHTML + "<br>" + data;//Enviamos un texto diciendo que X usuario se ha unido
  });
  socket.on("actualizar usuarios", function(data){//Lista de usuarios
    var nombres = '';
      for (var i = 0; i < data.length; i++) {
        if (i==0) {
          nombres = data[i];
        }else{
          nombres += ', '+data[i];
        }

      }
      usuarios.innerHTML = nombres;//Enviamos un texto diciendo que X usuario se ha unido
  });

  nTxt.addEventListener("keyup", function(event) {//Si pulsamos enter se envia el mensaje
      event.preventDefault();
      if (event.keyCode === 13) {//EL 13 es el enter
        document.getElementById("nBtn").click();
      }
  });
</script>

</body>
</html>
